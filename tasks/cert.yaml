---

- set_fact: letsencrypt_certbot_args="{{letsencrypt_certbot_args + ['--renew-by-default']}}"
  when: letsencrypt_force_renew == true

- set_fact: letsencrypt_certbot_args="{{letsencrypt_certbot_args + ['--keep-until-expiring']}}"
  when: letsencrypt_force_renew != true

- set_fact: letsencrypt_domain="{{letsencrypt_domain}},www.{{letsencrypt_domain}}"
  when: letsencrypt_request_www

- name: Stopping Services
  service: name="{{item}}" state=stopped
  with_items: "{{ letsencrypt_pause_services }}"

- name: Obtain or renew cert for domain
  shell: ./certbot-auto certonly -m {{ letsencrypt_email }} --domains {{ letsencrypt_domain }} --agree-tos --standalone --expand {{letsencrypt_certbot_args | join(' ')}}
  args:
    chdir: /opt/certbot
    executable: /bin/bash
  ignore_errors: true
  register: certbot_command

- fail: msg="{{certbot_command.stderr}}"
  when: (certbot_command.failed == true) and (certbot_command.stderr != 'User chose to cancel the operation and may reinvoke the client.')

- name: Starting Services
  service: name="{{item}}" state=started
  with_items: "{{ letsencrypt_pause_services }}"
